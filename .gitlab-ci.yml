image: gcc

before_script:
    - apt update && apt install -y cmake libhdf5-serial-dev

tests:
    only:
        - pushes
    script:
        - mkdir build
        - cd build
        - cmake ..
        - make -j4
        - ./tests
          # a few tests before setting things nicer
        - ARCH=$(echo $CI_RUNNER_EXECUTABLE_ARCH | tr / _)
        - echo $ARCH
        - echo $CI_PROJECT_URL
        - echo $CI_JOB_NAME
        - echo "$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/octreegen-$CI_COMMIT_TAG-$ARCH.deb?job=$CI_JOB_NAME"


build:
    only:
        - tags
    script:
        - mkdir build
        - cd build
        - ARCH=$(echo $CI_RUNNER_EXECUTABLE_ARCH | tr / _)
        - cmake .. -DTAG=$CI_COMMIT_TAG -DARCH=$ARCH
        - make package
        - mv *.deb ..
        - echo "$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/octreegen-$CI_COMMIT_TAG-$ARCH.deb?job=$CI_JOB_NAME"
    artifacts:
        paths:
            - "*.deb"

# https://gitlab.com/Dexter9313/octree-file-format/-/jobs/artifacts/0.0.1/raw/octreegen-0.0.1-unknown.deb?job=build
